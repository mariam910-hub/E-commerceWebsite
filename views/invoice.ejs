<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    
</head>
<body class="invoice bg-light">
    <div class="container py-4">
        <div class="invoice-box bg-white p-4 rounded shadow">
            <!-- Company Information -->
            <div class="text-center mb-4">
                <h2>Wardrobe Clothing Store</h2>
                <p>Kochi, Kerala, India</p>
            </div>
            
            <% let subtotal = 0; let totalTax = 0; let totalDiscountedPrice = 0; %>
            <% order.products.forEach(product => { 
                if (!product.isDelete && 
                    !(product.refundGivenMethod === "Wallet" && product.refundSuccess === true) &&
                    !(product.return_cancel && (product.return_cancel.cancelRequested === true || product.return_cancel.returnRequested === true))) { 
                    let tax = (product.totalPrice * 0.05).toFixed(2);
                    subtotal += product.totalPrice;
                    totalTax += parseFloat(tax);
                    totalDiscountedPrice += product.discountedPrice;
                }
            }); %>
            
            <% if (subtotal > 0) { %>
                <!-- Order & Delivery Details -->
                <div class="row">
                    <div class="col-md-6">
                        <h6>Delivered to:</h6>
                        <p>
                            <strong><%= order.address.fullName %></strong><br>
                            <%= order.address.houseName %>, <%= order.address.city %><br>
                            PIN: <%= order.address.pin %><br>
                            Phone: <%= order.address.phoneNumber %><br>
                            Email: <%= order.address.emailId %>
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end text-start mt-3 mt-md-0">
                        <h6>Order Details:</h6>
                        <p>
                            Order No: <strong><%= order.orderNumber %></strong><br>
                            Order Date: <strong><%= new Date(order.orderDate).toLocaleDateString() %></strong><br>
                            Payment Method: <strong><%= order.paymentDetails.method %></strong>
                        </p>
                    </div>
                </div>
                
                <!-- Product Table -->
                <div class="table-responsive mt-3">
                    <table class="table table-bordered">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>Product</th>
                                <th>Color</th>
                                <th>Size</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Tax (5%)</th>
                                <th>Total price</th>
                                <th>Discount (%)</th>
                                <th>Discounted price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% order.products.forEach(product => { 
                                if (!product.isDelete && 
                                    !(product.refundGivenMethod === "Wallet" && product.refundSuccess === true) &&
                                    !(product.return_cancel && (product.return_cancel.cancelRequested === true || product.return_cancel.returnRequested === true))) { %>
                                <tr>
                                    <td><%= product.productName %></td>
                                    <td><%= product.color %></td>
                                    <td><%= product.size %></td>
                                    <td class="text-center"><%= product.quantity %></td>
                                    <td class="text-end">₹<%= product.pricePerUnit.toFixed(2) %></td>
                                    <td class="text-end">₹<%= (product.totalPrice * 0.05).toFixed(2) %></td>
                                    <td class="text-end">₹<%= (product.totalPrice - (product.totalPrice * 0.05)).toFixed(2) %></td>
                                    <td class="text-end"><%= product.finalDiscount%>%</td>
                                    <td class="text-end">₹<%= product.discountedPrice.toFixed(2) %></td>
                                </tr>
                            <% } }); %>
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Section -->
                <div class="row mt-4">
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <table class="table">
                            <tr>
                                <th>Subtotal:</th>
                                <td class="text-end">₹<%= subtotal.toFixed(2) %></td>
                            </tr>
                            <tr>
                                <th>Final Discount (Incl. Offers & Coupons):</th>
                                <td class="text-end">₹<%= order.orderSummary.discount + order.orderSummary.couponDiscount %></td>
                            </tr>
                            <tr class="table-primary">
                                <th><strong>Total (After Discount & Tax):</strong></th>
                                <td class="text-end"><strong>₹<%= totalDiscountedPrice.toFixed(2) %></strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Download Button -->
                <% if (!isPdf) { %>
                    <div class="text-center">
                        <a href="/product/invoice/download/<%= order._id %>" class="btn btn-primary mt-3">Download PDF</a>
                    </div>
                <% } %>
            <% } else { %>
                <!-- No Products Message -->
                <div class="text-center mt-4">
                    <h5>No products available</h5>
                    <button class="btn btn-secondary mt-3" disabled>Download PDF</button>
                </div>
            <% } %>
            
            <!-- Footer -->
            <p class="text-center mt-4 text-muted">Thank you for shopping with us!</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
