<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wardrobe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <%- include('partials/navbar') %>
  
  <div class="container p-4 " id="mainLogin">
    <div class="auth-buttons">
      <button id="loginBtn" class="active">LOGIN</button>
      <button id="registerBtn">REGISTER</button>
    </div>

        <div id="forget_passwordForm" class="card p-4 mx-auto">
            <form id="forgotPasswordForm">
              <div class="or-divider">Enter Registered Email Id</div>
                <div class="mb-3">
                    <label for="registerEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="registerEmail" name="emailId" required>
                </div>
                <button type="submit" class="btn submitbutton w-50">Submit</button>
            </form>
            <p id="message" class="text-danger"></p>
        </div>
        
        <!-- Change Password Form -->
        <div id="change_password" class="card p-4 mx-auto d-none">
            <form id="resetPasswordForm">
              <div class="or-divider">Change your password</div>
                <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPassword" name="password" required>
                </div>
                <div class="mb-3">
                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmNewPassword" name="password" required>
                </div>
                <button type="submit" class="btn submitbutton w-50">Change Password</button>
            </form>
            <p id="passwordMessage" class="text-danger"></p>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
        // Handle Forgot Password Form
        document.getElementById("forgotPasswordForm").addEventListener("submit", async function(event) {
            event.preventDefault(); 
        
            const emailId = document.getElementById("registerEmail").value;
        
            const response = await fetch("/forgot_password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ emailId }),
            });
        
            const data = await response.json();
        
            if (data.success) {
                Swal.fire({
                  icon: "success",
                  text: "Email verified! You can now change your password.",
                  confirmButtonColor: "#d33",
                  customClass: {
                  popup: "custom-swal-popup",  // Custom class for the popup
                  confirmButton: "custom-ok-button", // Custom class for the OK button
                  icon: "custom-icon" // Custom class for the icon
                }
    });
        
                // Show the password reset form and hide email form
                document.getElementById('change_password').classList.remove('d-none');
                document.getElementById('forget_passwordForm').classList.add('d-none');
            } else {
                document.getElementById("message").innerText = data.message;
            }
        });
        
        // Handle Password Reset Form
        document.getElementById("resetPasswordForm").addEventListener("submit", async function(event) {
            event.preventDefault();
        
            const newPassword = document.getElementById("newPassword").value;
            const confirmNewPassword = document.getElementById("confirmNewPassword").value;
        
            // Password Validation
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            
            if (!passwordRegex.test(newPassword)) {
                document.getElementById("passwordMessage").innerText = "Password must be at least 8 characters, include 1 uppercase, 1 number, and 1 special character.";
                return;
            }
        
            if (newPassword !== confirmNewPassword) {
                document.getElementById("passwordMessage").innerText = "Passwords do not match.";
                return;
            }
        
            const response = await fetch("/reset_password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ emailId: document.getElementById("registerEmail").value, newPassword }),
            });
        
            const data = await response.json();
        
            if (data.success) {
              localStorage.setItem("successMessage", "Password changed successfully! You can now login using your new password.");
              window.location.href = "/login";
            } else {
                document.getElementById("passwordMessage").innerText = data.message;
            }
        });
        
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/main.js"></script>
        
</body>
</html>