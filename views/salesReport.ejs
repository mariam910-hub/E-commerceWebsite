<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style_admin.css">

    
</head>
<body>
    <p class="no-print "><a href="/admin/dashboard/sales">Go to dashboard</a></p>
    <div class="text-center mb-4">
        <h1 class="mt-5">Wardrobe Clothing Store</h1>
        <p>Kochi, Kerala, India</p>
    </div>
    <div class="container mt-5">
        <h3 class="text-center">Sales Report</h3>
        <p class="text-center"><strong><%= startDate %></strong> to <strong><%= endDate %></strong> </h3>
            
        
        <div id="download-buttons" class="no-print mb-5 text-center">
            <a href="/admin/sales/download-excel?isExcel=true&startDate=<%= startDate %>&endDate=<%= endDate %>&period=<%= period %>" class="btn btn-success download-link">Download Excel</a>
            <a href="/admin/sales/download-pdf?isPdf=true&startDate=<%= startDate %>&endDate=<%= endDate %>&period=<%= period %>" class="btn btn-danger download-link">Download PDF</a>
        </div>
    <!-- Sales Report Filter Form -->
         
    <form id="sales-filter-form" method="GET" action="/admin/sales-report" class="mb-4 no-print">
        <div class="row">
            <div class="col-md-4">
                <label for="period" class="form-label">Select Period:</label>
                <select name="period" id="period" class="form-select">
                    <option value="weekly" <%= period === 'weekly' ? 'selected' : '' %>>Weekly</option>
                    <option value="monthly" <%= period === 'monthly' ? 'selected' : '' %>>Monthly</option>
                    <option value="yearly" <%= period === 'yearly' ? 'selected' : '' %>>Yearly</option>
                    <option value="custom" <%= period === 'custom' ? 'selected' : '' %>>Custom</option>
                </select>
                
            </div>
    
            <div id="custom-date-range" class="col-md-6 <% if (period !== 'custom') { %> d-none <% } %>">
                <label for="startDate" class="form-label">Start Date:</label>
                <input type="date" name="startDate" id="startDate" class="form-control" value="<%= startDate || '' %>">
                <label for="endDate" class="form-label mt-2">End Date:</label>
                <input type="date" name="endDate" id="endDate" class="form-control" value="<%= endDate || '' %>">
            </div>
    
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </div>
        </div>
    </form>
        <!-- Sales Overview Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Total Orders</th>
                        <th>Total Orders Cancelled</th>
                        <th>Total Sales (₹)</th>
                        <th>Discounts Given (₹)</th>
                        <th>Coupon Reductions (₹)</th>
                        <th>Total Revenue (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><%= startDate %></td>
                        <td><%= endDate %></td>
                        <td><%= salesData.totalOrders %></td>
                        <td><%= salesData.totalCancelledOrders %></td>
                        <td>₹<%= salesData.totalRevenue +salesData.totalDiscount%></td>
                        <td>₹<%= salesData.totalDiscount %></td>
                        <td>₹<%= salesData.totalCouponDiscount %></td>
                        <td>₹<%= salesData.totalRevenue-salesData.totalCouponDiscount%></td>
                        
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
   

    <h5 class="text-center mt-3">Category-Wise Sales</h5>
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Category Name</th>
                <th>Sold Quantity</th>
                <th>Total Sales (₹)</th>
            </tr>
        </thead>
        <tbody>
            <% Object.values(salesData.categorySales).forEach(category => { %>
                <tr>
                    <td><%= category.name %></td>
                    <td><%= category.totalSold %></td>
                    <td>₹<%= category.sales || 0 %></td> <!-- Ensure sales value is handled properly -->
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<h5 class="text-center mt-3">Product Sales</h5>
<div class="table-container">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Product Name</th>
                <th>Sold</th>
                <th>Returned</th>
                <th>Price per Unit</th>
                <th>Total Price</th>
                <th>Total Sales (After Discount)</th>
            </tr>
        </thead>
        <tbody>
            <% Object.values(salesData.productSales).forEach((product, index) => { %>
                <tr class="product-row <% if(index >= 5) { %> hidden-row <% } %>">
                    <td><%= product.name %></td>
                    <td><%= product.sold %></td>
                    <td><%= product.returned %></td>
                    <td>₹<%= product.pricePerUnit %></td>
                    <td>₹<%= product.totalSales %></td>
                    <td>₹<%= product.discountSales %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<!-- Show More / Show Less Button -->
<div class="text-center mt-3 no-print">
    <button id="toggleBtn" class="btn btn-primary border:none">Show More</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <script>
document.addEventListener("DOMContentLoaded", function () {
    const periodSelect = document.getElementById("period");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customDateRange = document.getElementById("custom-date-range");

    periodSelect.addEventListener("change", function () {
        const selectedPeriod = periodSelect.value;
        const today = new Date();
        let start, end;

        if (selectedPeriod === "weekly") {
            start = new Date();
            start.setDate(today.getDate() - 7);
            end = new Date();
        } else if (selectedPeriod === "monthly") {
            start = new Date(today.getFullYear(), today.getMonth(), 1);
            end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        } else if (selectedPeriod === "yearly") {
            start = new Date(today.getFullYear(), 0, 1);
            end = new Date(today.getFullYear(), 11, 31);
        }

        if (selectedPeriod === "custom") {
            customDateRange.classList.remove("d-none"); // Show date fields
        } else {
            customDateRange.classList.add("d-none"); // Hide date fields
            if (start && end) {
                startDateInput.value = start.toISOString().split("T")[0]; // Set start date
                endDateInput.value = end.toISOString().split("T")[0]; // Set end date
            } else {
                startDateInput.value = ""; // Clear start date
                endDateInput.value = ""; // Clear end date
            }
        }
    });
});
document.getElementById('toggleBtn').addEventListener('click', function() {
        let hiddenRows = document.querySelectorAll('.hidden-row');
        let isHidden = hiddenRows[0].style.display === 'none' || hiddenRows[0].style.display === '';
        
        hiddenRows.forEach(row => {
            row.style.display = isHidden ? 'table-row' : 'none';
        });

        this.textContent = isHidden ? 'Show Less' : 'Show More';
    });

    document.querySelectorAll(".download-link").forEach(link => {
        link.addEventListener("click", function () {
            filterForm.style.display = "none"; 
            downloadButtons.style.display = "none";
        });
    });


    document.addEventListener("DOMContentLoaded", function() {
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");

        startDateInput.addEventListener("change", function() {
            endDateInput.min = startDateInput.value; 
        });

        endDateInput.addEventListener("change", function() {
            if (endDateInput.value < startDateInput.value) {
                Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'End Date cannot be earlier than Start Date!',
        });
                endDateInput.value = startDateInput.value; // Reset end date to start date
            }
        });
    });


</script>

</body>
</html>
